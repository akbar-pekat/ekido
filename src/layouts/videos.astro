---
import "../styles/videos.css";
import Button from "../components/button.astro";
import VideoItem from "../components/videoItem.astro";
---

<div class="contentMax-videos">
  <div class="videosSection" id="videosSection">
    <div class="container">
      <div class="headerSection">
        <p>
          Ekido spesialis konten pendek (Short-form) untuk TikTok/Instagram
          Reels, cocok untuk akun Brand atau Personal-mu.
        </p>
        <p id="klik">
          <small>Klik/hover icon play untuk putar videonya</small>
        </p>
      </div>

      <section class="splide" id="videosSplide">
        <div class="splide__arrows">
          <button class="splide__arrow splide__arrow--prev">
            <div class="arrowRight">
              <svg
                width="7"
                height="11"
                viewBox="0 0 7 11"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M0 2.11803C0 1.37465 0.782313 0.891156 1.44721 1.22361L8.21114 4.60557C8.94819 4.9741 8.94819 6.0259 8.21115 6.39443L1.44722 9.77639C0.782315 10.1088 0 9.62535 0 8.88197V2.11803Z"
                  fill="#5150E3"></path>
              </svg>
            </div>
          </button>
          <button class="splide__arrow splide__arrow--next">
            <div class="arrowRight">
              <svg
                width="7"
                height="11"
                viewBox="0 0 7 11"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M0 2.11803C0 1.37465 0.782313 0.891156 1.44721 1.22361L8.21114 4.60557C8.94819 4.9741 8.94819 6.0259 8.21115 6.39443L1.44722 9.77639C0.782315 10.1088 0 9.62535 0 8.88197V2.11803Z"
                  fill="#5150E3"></path>
              </svg>
            </div>
          </button>
        </div>

        <div class="splide__track">
          <ul class="splide__list">
            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753513467/asamlambunk_hqhtq8.webm"
                username="@asamlambunk"
                views="54,2K"
                description="Content Plan + Script + Video Editing"
              />
            </li>
            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753513446/doddy.prayogo_2_kvjg4l_bn8e0z.webm"
                username="@doddy.prayogo"
                views="31,1K"
                description="Video Editing"
              />
            </li>

            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753513449/merryclestari_sg5xzw_ayhs3x.webm"
                username="@merryclestari"
                views="291K"
                description="Scriptwriting + Video Editing"
              />
            </li>
            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753513445/jason_f065xa_libszb.webm"
                username="@jsnnath"
                views="1M"
                description="Video Editing"
              />
            </li>

            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753513458/romario_rage_p1f72q_r1y0ns.webm"
                username="@romario_rage"
                views="21,6M"
                description="Content Plan + Video Editing"
              />
            </li>
            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753513956/albert_zif8eb_yfljee.webm"
                username="@bangalbert.id"
                views="1M"
                description="Video Editing"
              />
            </li>

            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753513978/varuuyy_yqx2kp_h3uira.webm"
                username="@varuuyy"
                views="37,8K"
                description="Scriptwriting + Video Editing"
              />
            </li>
            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753513955/hendrikogani_2_nnkxzq_idkwit.webm"
                username="@hendrikogani"
                views="17K"
                description="Video Editing"
              />
            </li>

            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753513960/tantedianny_ouojre_jw2csh.webm"
                username="@dianypranata"
                views="100K"
                description="Video Editing"
              />
            </li>
            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753513956/kaizen_rbp4nb_qxqgjt.webm"
                username="@kaizenbarbershop"
                views="20K"
                description="Video Editing"
              />
            </li>

            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753732732/bts2_jrfzdb.mov"
                username="@"
                views="20K"
                description="Offline Shooting + Video Editing"
              />
            </li>
            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753732732/bts1_nluodq.mov"
                username="@"
                views="10K"
                description="Full Socmed Management"
              />
            </li>
          </ul>
        </div>
      </section>

      <div class="footerSection">
        <Button href="http://wa.link/2d3uae" color="blue" pulse scaleOnHover
          >Pesan Sekarang</Button
        >
        <p>Geser ke bawah untuk lihat jasa & portfolio kami â†“</p>
      </div>
      <img src="/asset1.svg" alt="asset1" class="asset1alt" />
      <img src="/asset2.svg" alt="asset2" class="asset2" />
    </div>
  </div>
</div>

<div class="video-popup-modal" id="videoPopupModal">
  <div class="video-popup-container">
    <div class="video-popup-header">
      <div class="video-popup-username" id="popupUsername"></div>
      <button class="video-popup-close" id="closePopup">&times;</button>
    </div>
    <div class="video-popup-content">
      <video id="popupVideo" controls playsinline></video>
    </div>
  </div>
</div>

<script>
  import Splide from "@splidejs/splide";

  const SELECTORS = {
    SPLIDE: "#videosSplide",
    SLIDE: ".splide__slide",
    VIDEO: ".portfolio-video",
    OVERLAY: ".video-overlay",
    MODAL: "#videoPopupModal",
    POPUP_VIDEO: "#popupVideo",
    POPUP_USER: "#popupUsername",
    CLOSE_BTN: "#closePopup",
  };

  const CLASSES = {
    ACTIVE: "active",
    NO_SCROLL: "no-scroll",
  };

  const videoStates = new WeakMap();

  document.addEventListener("DOMContentLoaded", () => {
    const splide = initSplide();
    initVideoStates(splide);
    initOverlayHover(splide);
    initVideoPopup();
  });

  function initSplide() {
    const splide = new Splide(SELECTORS.SPLIDE, {
      autoplay: true,
      type: "loop",
      perPage: 4,
      perMove: 1,
      gap: "16px",
      pagination: false,
      breakpoints: {
        1024: { perPage: 4 },
        768: { perPage: 3 },
        480: { perPage: 1 },
      },
    });

    splide.mount();
    return splide;
  }

  function initVideoStates(splide: Splide) {
    document.querySelectorAll(SELECTORS.VIDEO).forEach((video) => {
      videoStates.set(video, { interacted: false });
    });

    splide.on("mounted move", () => handleSlideChange(splide));
  }

  function handleSlideChange(splide: Splide) {
    const activeIndex = splide.index;
    const slides = document.querySelectorAll(
      `${SELECTORS.SPLIDE} ${SELECTORS.SLIDE}`
    );

    slides.forEach((slide, idx) => {
      const video = slide.querySelector(SELECTORS.VIDEO);
      if (!video) return;

      const { interacted } = videoStates.get(video) || {};
      if (idx === activeIndex && interacted) {
        (video as HTMLVideoElement).play();
      } else {
        (video as HTMLVideoElement).pause();
      }
    });
  }

  function initOverlayHover(splide: Splide) {
    document.querySelectorAll(SELECTORS.OVERLAY).forEach((overlay) => {
      overlay.addEventListener("mouseenter", (e: Event) =>
        onOverlayMouseEnter(e as MouseEvent)
      );
      overlay.addEventListener("mouseleave", (e: Event) =>
        onOverlayMouseLeave(e as MouseEvent)
      );
    });
  }

  function onOverlayMouseEnter(e: MouseEvent) {
    const overlay = e.currentTarget;
    const video = (overlay as HTMLElement)
      .closest(SELECTORS.SLIDE)
      ?.querySelector(SELECTORS.VIDEO);
    if (video) (video as HTMLVideoElement).play();
  }

  function onOverlayMouseLeave(e: MouseEvent) {
    const overlay = e.currentTarget;
    const video = (overlay as HTMLElement)
      .closest(SELECTORS.SLIDE)
      ?.querySelector(SELECTORS.VIDEO);
    if (!video) return;

    const state = videoStates.get(video);
    if (state && !state.interacted) {
      state.interacted = true;
      (video as HTMLVideoElement).loop = true;
    }
  }

  function initVideoPopup() {
    const modal = document.querySelector(SELECTORS.MODAL);
    const popupVideo = document.querySelector(SELECTORS.POPUP_VIDEO);
    const popupUser = document.querySelector(SELECTORS.POPUP_USER);
    const closeBtn = document.querySelector(SELECTORS.CLOSE_BTN);

    if (!modal || !popupVideo || !closeBtn) return;

    document.querySelectorAll(SELECTORS.OVERLAY).forEach((overlay) => {
      overlay.addEventListener("click", () =>
        openPopup(
          overlay as HTMLElement,
          modal as HTMLElement,
          popupVideo as HTMLVideoElement,
          popupUser as HTMLElement
        )
      );
    });

    (closeBtn as HTMLElement).addEventListener("click", () =>
      closePopup(modal as HTMLElement, popupVideo as HTMLVideoElement)
    );
    modal.addEventListener("click", (e) => {
      if (e.target === modal)
        closePopup(modal as HTMLElement, popupVideo as HTMLVideoElement);
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && modal.classList.contains(CLASSES.ACTIVE)) {
        closePopup(modal as HTMLElement, popupVideo as HTMLVideoElement);
      }
    });
  }

  function openPopup(
    overlay: HTMLElement,
    modal: HTMLElement,
    popupVideo: HTMLVideoElement,
    popupUser: HTMLElement | null
  ) {
    const src = overlay.getAttribute("data-video-src");
    const user = overlay.getAttribute("data-username") || "";

    if (!src) return;
    popupVideo.src = src;
    popupUser && (popupUser.textContent = user);

    modal.classList.add(CLASSES.ACTIVE);
    document.body.classList.add(CLASSES.NO_SCROLL);

    popupVideo.load();
    popupVideo.play();

    document
      .querySelectorAll(SELECTORS.VIDEO)
      .forEach((v) => (v as HTMLVideoElement).pause());
  }

  function closePopup(modal: HTMLElement, popupVideo: HTMLVideoElement) {
    modal.classList.remove(CLASSES.ACTIVE);
    popupVideo.pause();
    popupVideo.currentTime = 0;
    document.body.classList.remove(CLASSES.NO_SCROLL);
  }
</script>

---
import "../styles/videos.css";
import Button from "../components/button.astro";
import VideoItem from "../components/videoItem.astro";
---

<div class="contentMax-videos">
  <div class="videosSection" id="videosSection">
    <div class="container">
      <div class="headerSection">
        <p>
          Ekido spesialis konten pendek (Short-form) untuk TikTok/Instagram
          Reels, cocok untuk akun Brand atau Personal-mu.
        </p>
        <p id="klik">
          <small>Klik/hover icon play untuk putar videonya</small>
        </p>
      </div>

      <section class="splide" id="videosSplide">
        <div class="splide__arrows">
          <button class="splide__arrow splide__arrow--prev">
            <div class="arrowRight">
              <svg
                width="7"
                height="11"
                viewBox="0 0 7 11"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M0 2.11803C0 1.37465 0.782313 0.891156 1.44721 1.22361L8.21114 4.60557C8.94819 4.9741 8.94819 6.0259 8.21115 6.39443L1.44722 9.77639C0.782315 10.1088 0 9.62535 0 8.88197V2.11803Z"
                  fill="#5150E3"></path>
              </svg>
            </div>
          </button>
          <button class="splide__arrow splide__arrow--next">
            <div class="arrowRight">
              <svg
                width="7"
                height="11"
                viewBox="0 0 7 11"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M0 2.11803C0 1.37465 0.782313 0.891156 1.44721 1.22361L8.21114 4.60557C8.94819 4.9741 8.94819 6.0259 8.21115 6.39443L1.44722 9.77639C0.782315 10.1088 0 9.62535 0 8.88197V2.11803Z"
                  fill="#5150E3"></path>
              </svg>
            </div>
          </button>
        </div>

        <div class="splide__track">
          <ul class="splide__list">
            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753513467/asamlambunk_hqhtq8.webm"
                username="@asamlambunk"
                views="54,2K"
                description="Content Plan + Script + Video Editing"
              />
            </li>
            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753513446/doddy.prayogo_2_kvjg4l_bn8e0z.webm"
                username="@doddy.prayogo"
                views="31,1K"
                description="Video Editing"
              />
            </li>

            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753513449/merryclestari_sg5xzw_ayhs3x.webm"
                username="@merryclestari"
                views="291K"
                description="Scriptwriting + Video Editing"
              />
            </li>
            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753513445/jason_f065xa_libszb.webm"
                username="@jsnnath"
                views="1M"
                description="Video Editing"
              />
            </li>

            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753513458/romario_rage_p1f72q_r1y0ns.webm"
                username="@romario_rage"
                views="21,6M"
                description="Content Plan + Video Editing"
              />
            </li>
            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753513956/albert_zif8eb_yfljee.webm"
                username="@bangalbert.id"
                views="1M"
                description="Video Editing"
              />
            </li>

            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753513978/varuuyy_yqx2kp_h3uira.webm"
                username="@varuuyy"
                views="37,8M"
                description="Scriptwriting + Video Editing"
              />
            </li>
            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753513955/hendrikogani_2_nnkxzq_idkwit.webm"
                username="@hendrikogani"
                views="7,252"
                description="Video Editing"
              />
            </li>

            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753513960/tantedianny_ouojre_jw2csh.webm"
                username="@dianypranata"
                views="500K"
                description="Video Editing"
              />
            </li>
            <li class="splide__slide">
              <VideoItem
                src="https://res.cloudinary.com/apclient/video/upload/f_auto,q_auto/v1753513956/kaizen_rbp4nb_qxqgjt.webm"
                username="@kaizenbarbershop"
                views="20K"
                description="Video Editing"
              />
            </li>
          </ul>
        </div>
      </section>

      <div class="footerSection">
        <Button href="http://wa.link/2d3uae" color="blue" pulse scaleOnHover
          >Pesan Sekarang</Button
        >
        <p>Geser ke bawah untuk lihat jasa & portfolio kami â†“</p>
      </div>
      <img src="/asset1.svg" alt="asset1" class="asset1alt" />
      <img src="/asset2.svg" alt="asset2" class="asset2" />
    </div>
  </div>
</div>

<!-- Tambahkan ini di akhir file, sebelum tag </div> terakhir -->
<div class="video-popup-modal" id="videoPopupModal">
  <div class="video-popup-container">
    <div class="video-popup-header">
      <div class="video-popup-username" id="popupUsername"></div>
      <button class="video-popup-close" id="closePopup">&times;</button>
    </div>
    <div class="video-popup-content">
      <video id="popupVideo" controls playsinline></video>
    </div>
  </div>
</div>

<!-- Tambahkan script ini di dalam tag <script> yang sudah ada, setelah splide.mount(); -->
<script>
  import Splide from "@splidejs/splide";

  document.addEventListener("DOMContentLoaded", function () {
    const splide = new Splide("#videosSplide", {
      autoplay: true,
      type: "loop",
      perPage: 4,
      perMove: 1,
      gap: "16px",
      pagination: false,
      breakpoints: {
        1024: {
          perPage: 4,
        },
        768: {
          perPage: 3,
        },
        480: {
          perPage: 1,
        },
      },
    });

    const videoStates = new WeakMap();

    splide.on("mounted move", () => {
      const slides = document.querySelectorAll("#videosSplide .splide__slide");
      const activeIndex = splide.index;

      slides.forEach((slide, index) => {
        const video = slide.querySelector(".portfolio-video");
        if (!video) return;

        const state = videoStates.get(video) || { interacted: false };

        if (index === activeIndex && state.interacted) {
          (video as HTMLVideoElement).play();
        } else {
          (video as HTMLVideoElement).pause();
        }
      });
    });

    document.querySelectorAll(".portfolio-video").forEach((video) => {
      videoStates.set(video, { interacted: false });

      // Modifikasi: Tambahkan event listener untuk video-overlay
      document.querySelectorAll(".video-overlay").forEach((overlay) => {
        const slide = overlay.closest(".splide__slide");
        const video = slide?.querySelector(".portfolio-video") as HTMLVideoElement;
        
        if (video) {
          // Event mouseenter pada overlay
          overlay.addEventListener("mouseenter", () => {
            video.play();
          });
      
          // Event mouseleave pada overlay
          overlay.addEventListener("mouseleave", () => {
            const state = videoStates.get(video);
            if (state && !state.interacted) {
              state.interacted = true;
              video.loop = true;
              videoStates.set(video, state);
            }
          });
        }
      });
    });

    splide.mount();

    // Tambahkan kode untuk popup video
    const videoPopupModal = document.getElementById("videoPopupModal");
    const popupVideo = document.getElementById("popupVideo");
    const popupUsername = document.getElementById("popupUsername");
    const closePopup = document.getElementById("closePopup");

    // Event listener untuk membuka popup
    document.querySelectorAll(".video-overlay").forEach((overlay) => {
      overlay.addEventListener("click", (e) => {
        const videoSrc = overlay.getAttribute("data-video-src");
        const username = overlay.getAttribute("data-username");

        if (videoSrc && popupVideo) {
          // Set video source dan username
          (popupVideo as HTMLVideoElement).src = videoSrc;
          if (popupUsername) {
            popupUsername.textContent = username;
          }

          // Tampilkan popup
          if (videoPopupModal) {
            videoPopupModal.classList.add("active");
          }

          // Play video
          (popupVideo as HTMLVideoElement).load();
          (popupVideo as HTMLVideoElement).play();

          // Pause semua video lain
          document.querySelectorAll(".portfolio-video").forEach((video) => {
            (video as HTMLVideoElement).pause();
          });

          // Prevent body scrolling
          document.body.style.overflow = "hidden";
        }
      });
    });

    // Event listener untuk menutup popup
    if (closePopup) {
      closePopup.addEventListener("click", () => {
        // Sembunyikan popup
        if (videoPopupModal) {
          videoPopupModal.classList.remove("active");
        }

        // Pause dan reset video
        if (popupVideo) {
          (popupVideo as HTMLVideoElement).pause();
          (popupVideo as HTMLVideoElement).currentTime = 0;
        }

        // Allow body scrolling
        document.body.style.overflow = "";
      });
    }

    // Tutup popup jika klik di luar container
    if (videoPopupModal) {
      videoPopupModal.addEventListener("click", (e) => {
        if (e.target === videoPopupModal) {
          if (closePopup) {
            closePopup.click();
          }
        }
      });
    }

    // Tutup popup dengan tombol ESC
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && videoPopupModal?.classList.contains("active")) {
        if (closePopup) {
          closePopup.click();
        }
      }
    });
  });
</script>
